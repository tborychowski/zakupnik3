<form ref:form class="form {inEdit ? 'edit' : ''}" on:submit="onsubmit(event)">
	<div class="form-row">
		<input type="hidden" name="id" bind:value="id">
		<textarea autofocus
			ref:textbox
			tabindex="1"
			placeholder="e.g. tesco 12.50"
			on:focus="onfocus()"
			on:input="oninput()"
			on:keydown="onkeydown(event)"
			bind:value="text"></textarea>
	</div>
	<div class="form-footer form-row">
		<button type="button" tabindex="3" class="btn btn-reset" on:click="reset()">Clear</button>
		<button type="button" tabindex="4" class="btn danger btn-remove" on:click="remove()">Remove</button>
		<div class="flex-filler"></div>
		<button type="button" tabindex="3" class="btn btn-cancel" on:click="reset()">Cancel</button>
		<button type="submit" tabindex="2" class="btn success btn-save">Save</button>
		<button type="submit" tabindex="2" class="btn success btn-add">Add</button>
	</div>
</form>

<script>
import Parser from './text-parser';

function formatNumber (num) {
	num = Math.round(0 + num * 100) / 100;
	return num.toLocaleString('en-GB', { minimumFractionDigits: 2 })
}

export default {
	data () {
		return {
			inEdit: false,
			date: new Date().toISOString().substr(0, 7),
			id: null,
			text: '',
			groups: [],
			rows: [],
		};
	},
	computed: {
		_groups ({groups}) {
			return groups.map(g => {
				// const str = (g.name + ',' + g.keywords).toLowerCase().split(',');
				const escaped = g.name.replace(/[-[\]/{}()*+?.\\^$|]/g, '\\$&');
				g._name = new RegExp(escaped, 'i');
				return g;
			});
		}
	},

	methods: {
		onfocus () {
			this.parse();
		},

		oninput () {
			this.toggleAmountError();
			this.updateHeight();
			this.parse();
		},

		onkeydown (e) {
			if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) this.onsubmit(e);
			else if (e.key === 'Escape') this.reset(e);
		},

		parse () {
			if (this.parseTimer) clearTimeout(this.parseTimer);
			this.parseTimer = setTimeout(() => {
				const rows = Parser.parse(this.get().text, this.get());
				this.set({ rows });
				this.fire('change', rows);
			}, 300);
		},

		edit (data) {
			this.reset();
			const text = `${data.group.name} ${data.description} ${formatNumber(data.amount)}`;
			this.set({ inEdit: true, id: data.id, date: data.date, text });
			this.fire('change', this.get().rows);
		},

		reset () {
			this.set({ inEdit: false, id: null, text: '', rows: [] });
			this.toggleAmountError();
			this.fire('change', []);
			this.updateHeight();
			this.refs.textbox.focus();
		},

		remove () {
			this.fire('remove', { id: this.get().id });
			this.reset();
		},

		onsubmit (e) {
			e.preventDefault();
			const data = this.get();
			const rows = data.rows;
			if (!rows.length) {
				this.toggleAmountError('Please enter amount and category');
				return this.fire('error', 'Please enter amount and category');
			}
			// item was edited
			if (data.id && rows.length === 1) rows[0].id = data.id;
			const items = rows.map(this.leanItemForSave);
			this.fire('submit', items);
			this.reset();
		},

		leanItemForSave (item) {
			return {
				id: item.id,
				date: item.date,
				amount: item.amount,
				description: item.description,
				group_id: item.group_id
			};
		},

		toggleAmountError (msg = '') {
			this.refs.textbox.setCustomValidity(msg);
		},

		updateHeight () {
			const noLines = this.refs.textbox.value.split('\n').length;
			this.refs.textbox.style.height = `${noLines * 1.1}em`;
		},

	}
};
</script>
