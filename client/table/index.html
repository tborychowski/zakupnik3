<div class="table" ref:table>
	<table>
	<thead><tr>
		<td class="date">Date</td>
		<td class="desc">Description</td>
		<td class="amount">Amount</td>
	</tr></thead>
	<tbody>
		{#if filteredData && filteredData.length}
		{#each filteredData as item, idx}
			<tr class="table-row" on:click="onRowClick(item)">
				<td class="date">{item.date.substr(0, 7)}</td>
				<td class="desc">{getDescription(item)}</td>
				<td class="amount">{formatNumber(item.amount)}</td>
			</tr>
		{/each}
			<tr class="row-filler"><td colspan="3"></td></tr>
		{:else}
			<tr class="empty-row"><td colspan="3">No results</td></tr>
		{/if}
	</tbody>
	<tfoot><tr>
		<td colspan="2" class="table-filter-cell">
			<div class="table-filter-cell-inner">
				<i class="ion-md-search"></i>
				<input class="table-filter" type="search" placeholder="Filter"
				bind:value="filter"
				on:keydown="onFilterKeyDown(event)">
			</div>
		</td>
		<td class="amount">{formatNumber(total)}</td>
	</tr></tfoot>
	</table>
</div>


<script>
import {$} from '../core';

export default {
	data () {
		return {
			data: [],
			filter: '',
			isPreview: false
		};
	},
	helpers: {
		formatNumber: $.formatNumber,
		getDescription (item) {
			const desc = [];
			if (item.group.name) desc.push(item.group.name);
			if (item.description) desc.push(item.description);
			return desc.join(' - ');
		}
	},
	computed: {
		filteredData ({data, filter}) {
			if (!filter) return data;
			filter = filter.toLowerCase();
			return data.filter(item => {
				let s = item.description + item.amount + item.date;
				if (item.group) {
					s += (item.group.name || '');
					if (item.group.category) s += (item.group.category.name || '');
				}
				return (s.toLowerCase().indexOf(filter) > -1);
			});
		},
		total ({filteredData}) { return filteredData.reduce((p, c) => p + c.amount, 0); }
	},
	methods: {
		onFilterKeyDown (e) {
			if (e.key === 'Escape') this.set({ filter: '' });
		},
		onRowClick (item) {
			if (!this.get().isPreview) this.fire('click', item);
		}
	}
};
</script>
