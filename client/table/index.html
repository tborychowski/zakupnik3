<div class="table" ref:table>
	<table>
	<thead><tr>
		<td class="date">Date</td>
		<td class="desc">Description</td>
		<td class="amount">Amount</td>
	</tr></thead>
	<tbody>
		{#if isLoading}
			<tr class="empty-row"><td colspan="3">Loading...</td></tr>
		{:else}
			{#if filteredData.length}
			{#each filteredData as item, idx}
				<tr class="table-row" on:click="onRowClick(item)">
					<td class="date">{item.date.substr(0, 7)}</td>
					<td class="desc">{getDescription(item)}</td>
					<td class="amount">{formatNumber(item.amount)}</td>
				</tr>
			{/each}
				<tr class="row-filler"><td colspan="3"></td></tr>
			{:else}
				<tr class="empty-row"><td colspan="3">No results</td></tr>
			{/if}
		{/if}
	</tbody>
	<tfoot><tr>
		<td colspan="2" class="table-filter-cell">
			<div class="table-filter-cell-inner {filter.length ? 'filtered' : ''}">
				<i class="ion-md-search"></i>
				<input class="table-filter-input" type="search" placeholder="Filter"
				bind:value="filter"
				on:keydown="onFilterKeyDown(event)">
				<i class="ion-md-close table-clear-filter" on:click="clearFilter()"></i>
			</div>
		</td>
		<td class="amount">{formatNumber(total)}</td>
	</tr></tfoot>
	</table>
</div>


<script>
import {$} from '../core';
import Data from '../data';

export default {
	data () {
		return {
			isLoading: true,
			data: [],
			date: new Date().toISOString().substr(0, 7),
			filter: '',
			isPreview: false
		};
	},
	oncreate () {
		this.load();
	},
	onstate({ changed, current, previous }) {
		if (previous && changed.date) this.load();
		if (changed.filter && current.filter === '') this.fire('filter', '');
	},
	helpers: {
		formatNumber: $.formatNumber,
		getDescription (item) {
			const desc = [];
			if (item.group && item.group.name) desc.push(item.group.name);
			if (item.description) desc.push(item.description);
			return desc.join(' - ');
		}
	},
	computed: {
		filteredData ({data, filter}) {
			if (!filter) return data;
			filter = filter.toLowerCase();
			return data.filter(item => {
				let s = item.description + item.amount + item.date;
				if (item.group) {
					s += (item.group.name || '');
					if (item.group.category) s += (item.group.category.name || '');
				}
				return (s.toLowerCase().indexOf(filter) > -1);
			});
		},
		total ({filteredData}) { return filteredData.reduce((p, c) => p + c.amount, 0); }
	},
	methods: {
		load () {
			this.set({ isLoading: true });
			Data.Expenses.get(this.get().date).then(data => {
				this.originalData = data;
				this.set({ data, isLoading: false });
			});
		},

		onFilterKeyDown (e) {
			if (e.key === 'Escape') this.set({ filter: '' });
		},

		onRowClick (item) {
			if (!this.get().isPreview) this.fire('click', item);
		},

		clearFilter () {
			this.set({ filter: '' });
			this.fire('filter', '');
		},

		// temporary set data
		preview (data) {
			this.set({ data });
		},

		endPreview () {
			this.set({ data: this.originalData });
		}
	}
};
</script>
