<div class="table" ref:table>
	<table>
	<thead><tr>
		<td class="date">Date</td>
		<td class="cat"></td>
		<td class="desc">Description</td>
		<td class="amount">Amount</td>
	</tr></thead>
	<tbody>
		{#if isLoading}
			<tr class="empty-row"><td colspan="4">Loading...</td></tr>
		{:else}
			{#if filteredData.length}
			{#each filteredData as item, idx}
				<tr class="table-row" on:dblclick="onRowClick(item)">
					<td class="date">{item.date}</td>
					<td class="cat"><span class="pill">{getCategory(item)}</span></td>
					<td class="desc">{getDescription(item)}</td>
					<td class="amount">{formatNumber(item.amount)}</td>
				</tr>
			{/each}
				<tr class="row-filler"><td colspan="4"></td></tr>
			{:else}
				<tr class="empty-row"><td colspan="4">No results</td></tr>
			{/if}
		{/if}
	</tbody>
	<tfoot><tr><td colspan="3"></td><td class="amount">{formatNumber(total)}</td></tr></tfoot>
	</table>

	<div class="table-filter-box {filter.length ? 'filtered' : ''}">
		<i class="btn-search">⚲</i>
		<input class="table-filter-input" placeholder="Filter"
		bind:value="filter"
		on:keydown="onFilterKeyDown(event)">
		<i class="btn-clear" on:click="clearFilter()">×</i>
	</div>
</div>


<script>
import {formatNumber} from '../util';
import Data from '../data';

export default {
	data () {
		return {
			isLoading: true,
			isPreview: false,
			data: [],
			date: new Date().toISOString().substr(0, 10),
			filter: '',
			isPreview: false
		};
	},
	oncreate () {
		this.load();
	},
	onstate({ changed, current, previous }) {
		if (previous && changed.date) this.load();
		if (changed.filter && current.filter === '') this.fire('filter', '');
	},
	helpers: {
		formatNumber,
		getCategory (item) {
			return item && item.group && item.group.category && item.group.category.name || '';
		},
		getDescription (item) {
			const desc = [];
			if (item.group && item.group.name) desc.push(item.group.name);
			if (item.description) desc.push(item.description);
			return desc.join(' - ');
		}
	},
	computed: {
		filteredData ({data, filter}) {
			if (!filter) return data;
			filter = filter.toLowerCase();
			return data.filter(item => {
				let s = item.description + item.amount + item.date;
				if (item.group) {
					s += (item.group.name || '');
					if (item.group.category) s += (item.group.category.name || '');
				}
				return (s.toLowerCase().indexOf(filter) > -1);
			});
		},
		total ({filteredData}) { return filteredData.reduce((p, c) => p + c.amount, 0); }
	},
	methods: {
		load () {
			const data = this.get();
			if (data.isPreview) return;
			if (!data.data.length) this.set({ isLoading: true });
			Data.Expenses.get(data.date).then(data => {
				this.originalData = data;
				this.set({ data, isLoading: false });
			});
		},

		onFilterKeyDown (e) {
			if (e.key === 'Escape') this.set({ filter: '' });
		},

		onRowClick (item) {
			if (!this.get().isPreview) this.fire('click', item);
		},

		clearFilter () {
			this.set({ filter: '' });
			this.fire('filter', '');
		},

		// temporary set data
		preview (data) {
			this.set({ data, isPreview: true });
		},

		endPreview () {
			this.set({ data: this.originalData, isPreview: false });
		}
	}
};
</script>
