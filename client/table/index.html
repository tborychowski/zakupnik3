<div class="table" ref:table>
	<table>
	<thead><tr>
		<th class="date">Date</th>
		<th class="cat"></th>
		<th class="desc">Description</th>
		<th class="amount">Amount</th>
	</tr></thead>
	<tbody>
		{#if isLoading}
			<tr class="empty-row"><td colspan="4">Loading...</td></tr>
		{:else}
			{#if filteredData.length || $rowsWithCategories.length}

			{#each $rowsWithCategories.filter(r => !!r.id) as item, idx}
				<tr class="table-row table-row-edited">
					<td class="date">{item.date}</td>
					<td class="cat"><span class="pill">{getCategory(item)}</span></td>
					<td class="desc">{getDescription(item)}</td>
					<td class="amount">{formatNumber(item.amount)}</td>
				</tr>
			{/each}


			{#each filteredData as item, idx}
				<tr class="table-row {item.edited ? 'table-row-edited' : ''}" on:dblclick="onRowClick(item)">
					<td class="date">{item.date}</td>
					<td class="cat"><span class="pill">{getCategory(item)}</span></td>
					<td class="desc">{getDescription(item)}</td>
					<td class="amount">{formatNumber(item.amount)}</td>
				</tr>
			{/each}
				<tr class="row-filler"><td colspan="4">&nbsp;</td></tr>
			{:else}
				<tr class="empty-row"><td colspan="4">No results</td></tr>
			{/if}
		{/if}
	</tbody>
	<tfoot><tr>
		<th colspan="3">Spending per month</th>
		<th class="amount">{formatNumber(total)}</th>
	</tr></tfoot>
	</table>
</div>


<script>
import {formatNumber} from '../util';
import {Data, Store, EVENT} from '../data';

export default {
	store: () => Store,
	data () {
		return {
			isLoading: true,
			data: [],
		};
	},
	oncreate () {
		this.store.on('state', ({ current, changed, previous }) => {
			if (previous && changed.date) this.load();
		});

		EVENT.on(EVENT.item.updated, this.load.bind(this));

		this.load();
	},
	helpers: {
		formatNumber,
		getCategory (item) {
			return item && item.group && item.group.category && item.group.category.name || '';
		},
		getDescription (item) {
			const desc = [];
			if (item.group && item.group.name) desc.push(item.group.name);
			if (item.description) desc.push(item.description);
			return desc.join(' - ');
		}
	},
	computed: {
		filteredData ({data, $desc, $category, $group, $item}) {
			data.forEach(item => {
				item.edited = $item && item.id === $item.id;
			});
			if ($group) return data.filter(item => item.group.id === $group.id);
			if ($category) return data.filter(item => item.group.category.id === $category.id);
			if ($desc) {
				$desc = $desc.toLowerCase();
				return data.filter(item => {
					return (item.description.toLowerCase() + item.amount).includes($desc);
				});
			}
			return data;
		},
		total ({filteredData}) {
			if (!Array.isArray(filteredData)) return 0;
			return filteredData.reduce((p, c) => p + c.amount, 0);
		}
	},
	methods: {
		load () {
			const data = this.get();
			if (!data.data.length) this.set({ isLoading: true });
			const {dateStr} = this.store.get();
			Data.Expenses
				.get(dateStr)
				.then(res => {
					this.originalData = res;
					this.set({ data: res, isLoading: false });
				});
		},

		onRowClick (item) {
			this.store.set({ item });
		},
	}
};
</script>
