<div class="chart"><canvas ref:canvas width="100%" height="200"></canvas></div>

<script>
import {Data, Store} from '../data';
import MyChart from './chart';

export default {
	store: () => Store,
	data () { return { isLoading: true }; },
	oncreate () {
		this.init();

		this.store.on('state', ({ current, changed, previous }) => {
			if (previous && changed.date) this.load();
			if (previous && changed.category) this.load();
			if (previous && changed.group) this.load();
		});
	},

	methods: {
		init () {
			if (!window.Chart) return setTimeout(() => this.init(), 200);
			if (!this.chart) this.chart = new MyChart(this.refs.canvas);
			this.load();
		},

		load () {
			this.set({ isLoading: true });
			let {date, category, group} = this.store.get();
			if (category) category = category.id;
			if (group) group = group.id;
			Data.Stats.get({ year: date.y, group, category }).then(expenses => {
				this.chart.set(expenses, date.m);
				this.set({ isLoading: false });
			});
		},

	}
};
</script>
