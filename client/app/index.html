<div class="form-box">
	<YearMonthPicker ref:picker></YearMonthPicker>
	<Form ref:form></Form>
</div>
<Table ref:table></Table>
<Chart></Chart>
<Categories ref:categories></Categories>

<script>
import YearMonthPicker from '../year-month-picker';
import Form from '../form';
import Table from '../table';
import Categories from '../categories';
import Chart from '../chart';
import Data from '../data';

export default {
	data () { return {}; },
	components: { Form, Table, YearMonthPicker, Categories, Chart },
	oncreate () {
		const date = new Date().toISOString().substr(0, 7);
		Data.Groups.get().then(groups => this.refs.form.set({ date, groups }));
		Data.Categories.get().then(categories => this.refs.categories.set({ categories }));
		this.loadTable(date);

		this.refs.form.on('change', this.onFormChange.bind(this));
		this.refs.form.on('remove', this.onRemoveItem.bind(this));
		this.refs.form.on('submit', this.onFormSubmit.bind(this));
		this.refs.form.on('error', this.onFormError.bind(this));
		this.refs.picker.on('change', this.onDateChange.bind(this));
		this.refs.table.on('click', this.onTableClick.bind(this));
	},

	methods: {
		loadTable (date) {
			if (!date) date = this.lastDate;
			else this.lastDate = date;
			Data.Expenses.get(date).then(data => {
				this.lastTableData = data;
				this.refs.table.set({ data });
			});
		},

		onDateChange (date) {
			this.refs.form.set({ date: date.dateStr });
			this.loadTable(date.dateStr);
		},

		onFormChange (data) {
			if (data && data.length) {
				this.refs.table.set({ data, isPreview: true });
			}
			else {
				this.refs.table.set({ data: this.lastTableData, isPreview: false });
			}
		},

		onFormSubmit (data) {
			Expenses.save(data).then(() => this.loadTable());
		},

		onRemoveItem (item) {
			Expenses.del(item.id).then(() => this.loadTable());
		},

		onFormError (err) {
			console.log(err);	// TODO: toast?
		},

		onTableClick (item) { this.refs.form.edit(item); },
	}
};

</script>
