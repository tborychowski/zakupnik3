<Categories ref:categories></Categories>
<div class="form-box">
	<YearMonthPicker ref:picker></YearMonthPicker>
	<Form ref:form></Form>
</div>
<Table ref:table></Table>
<Chart ref:chart></Chart>

<script>
import Categories from '../categories';
import YearMonthPicker from '../year-month-picker';
import Form from '../form';
import Table from '../table';
import Chart from '../chart';

export default {
	components: { YearMonthPicker, Categories, Form, Table, Chart },
	oncreate () {
		this.refs.form.on('change', this.onFormChange.bind(this));
		this.refs.form.on('remove', this.onFormSubmit.bind(this));
		this.refs.form.on('submit', this.onFormSubmit.bind(this));

		this.refs.picker.on('change', this.onDateChange.bind(this));

		this.refs.table.on('click', this.onTableClick.bind(this));
		this.refs.table.on('filter', this.onFilterUpdated.bind(this));

		this.refs.categories.on('click', this.onCategoryClick.bind(this));
		this.refs.categories.on('updated', this.onCategoryUpdated.bind(this));
	},

	methods: {
		onDateChange (date) {
			this.refs.categories.set({ date: date.dateStr });
			this.refs.form.set({ date: date.dateStr });
			this.refs.table.set({ date: date.dateStr });
			this.refs.chart.set({ date: date.dateStr });
		},

		onFilterUpdated (val) {
			if (val === '') this.refs.chart.set({ category: null, group: null });
		},

		onCategoryClick (item) {
			this.refs.table.set({ filter: item.name });

			if (item.category_id) this.refs.chart.set({ group: item.id });
			else this.refs.chart.set({ category: item.id });
		},

		onCategoryUpdated () {
			this.refs.form.loadCategories();
		},

		onFormChange (data) {
			if (data && data.length) this.refs.table.preview(data);
			else this.refs.table.endPreview();
		},

		onFormSubmit () {
			this.refs.categories.load();
			this.refs.table.load();
			this.refs.chart.load();
		},

		onTableClick (item) { this.refs.form.edit(item); },
	}
};

</script>
